#!/bin/sh
# Send commands to tmux toggle panes
# Usage: tmux-send-to-toggle <toggle_id> <command>
# Example: tmux-send-to-toggle 1 "npm test"

set -e

if [ $# -lt 2 ]; then
    echo "Usage: tmux-send-to-toggle <toggle_id> <command>" >&2
    echo "" >&2
    echo "Examples:" >&2
    echo "  tmux-send-to-toggle 1 'npm test'" >&2
    echo "  tmux-send-to-toggle 2 'tail -f app.log'" >&2
    echo "  tmux-send-to-toggle 3 'python script.py'" >&2
    exit 1
fi

TOGGLE_ID="$1"
shift
COMMAND="$*"

# Validate toggle ID
case "$TOGGLE_ID" in
    1|2|3|4) ;;
    *) echo "Error: Toggle ID must be 1, 2, 3, or 4" >&2; exit 1 ;;
esac

# Get current tmux context
SESSION_ID=$(tmux display-message -p '#{session_id}')
WINDOW_ID=$(tmux display-message -p '#{window_id}')

# Strip special characters ($@%)
SESSION_NUM=$(echo "$SESSION_ID" | tr -d '$@%')
WINDOW_NUM=$(echo "$WINDOW_ID" | tr -d '$@%')

# Construct marker name
MARKER="toggle_${SESSION_NUM}_${WINDOW_NUM}_${TOGGLE_ID}"

# Find toggle pane by searching for matching marker
TARGET_PANE=""
for pane in $(tmux list-panes -F '#{pane_id}'); do
    marker=$(tmux show-option -pqv -t "$pane" @toggle_marker 2>/dev/null || true)
    if [ "$marker" = "$MARKER" ]; then
        TARGET_PANE="$pane"
        break
    fi
done

# If toggle exists and is visible, send command directly
if [ -n "$TARGET_PANE" ]; then
    echo "Sending to toggle $TOGGLE_ID (pane $TARGET_PANE): $COMMAND" >&2
    tmux send-keys -t "$TARGET_PANE" "$COMMAND" Enter
    exit 0
fi

# Toggle not visible - check if it's hidden
HIDDEN_EXISTS=$(tmux list-windows -t _toggle_hidden -F '#{window_name}' 2>/dev/null | grep -Fx "$MARKER" || true)

if [ -n "$HIDDEN_EXISTS" ]; then
    echo "Toggle $TOGGLE_ID is hidden. Showing it first..." >&2

    # Get the current window to make sure we're in the right context
    CURRENT_WINDOW=$(tmux display-message -p '#{window_id}')

    # Show the toggle by calling tmux-toggle directly (more reliable than send-keys)
    ~/.local/bin/tmux-toggle "$TOGGLE_ID" 2>/dev/null

    # Wait a moment for toggle to appear
    sleep 0.3

    # Find it again now that it's visible
    for pane in $(tmux list-panes -t "$CURRENT_WINDOW" -F '#{pane_id}'); do
        marker=$(tmux show-option -pqv -t "$pane" @toggle_marker 2>/dev/null || true)
        if [ "$marker" = "$MARKER" ]; then
            TARGET_PANE="$pane"
            break
        fi
    done

    if [ -n "$TARGET_PANE" ]; then
        echo "Sending to toggle $TOGGLE_ID (pane $TARGET_PANE): $COMMAND" >&2
        tmux send-keys -t "$TARGET_PANE" "$COMMAND" Enter
        exit 0
    else
        echo "Error: Failed to show toggle $TOGGLE_ID" >&2
        exit 1
    fi
else
    echo "Error: Toggle $TOGGLE_ID doesn't exist." >&2
    echo "Create it first by pressing C-h/j/k/l in tmux." >&2
    exit 1
fi
